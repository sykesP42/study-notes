# 网络核心

## 一、网络核心概述

### 1. 网络核心的作用与组成
- **基本组成**：由**交换节点**（路由器、交换机）和它们之间的**链路**构成。
- **核心功能**：实现**数据交换**，将源主机发出的数据正确、高效地传输到目标主机，是互联网的“中流砥柱”。
- **逻辑位置**：位于“网络边缘”（主机和应用）和“接入网”之后，构成全球性的数据交换骨干。

---

## 二、数据交换的两种核心方式

### 1. 电路交换

- **基本思想**：为通信双方**预先建立一条专用的物理通信路径**，全程独占资源。
- **工作流程**：
    1. **连接建立**：通过信令系统（如拨号）建立端到端连接。
    2. **资源分配**：为本次通信分配固定的链路带宽资源（如64kbps）。
    3. **通信**：双方在独占路径上进行数据传输。
    4. **连接释放**：通信结束后释放所占用的资源。
- **技术实现**（多路复用）：
    - **频分多路复用 (FDM)**：将链路总频带划分为多个子频带，每个用户独占一个。
    - **时分多路复用 (TDM)**：将时间划分为固定周期，每个周期内为每个用户分配一个固定时隙。
    - **波分多路复用 (WDM)**：在光纤中划分不同波长（光波段）给不同用户。
- **特点**：
    - **优点**：性能有保障（固定带宽、低延迟、按序到达）。
    - **缺点**：**资源利用率低**（空闲期资源被浪费）；**连接建立耗时**（如传统电话约1-2秒）。
    - **典型应用**：传统电话网络。

**计算示例（TDM链路传输时间）**:
- 已知：链路带宽1.536Mbps，划分为24个时隙（TDM），则每个用户独占带宽为 `1.536 Mbps / 24 = 64 kbps`。
- 传输一个640 Kb的文件，传输时间 = `640 Kb / 64 kbps = 10 s`。
- 若连接建立时间为500 ms，则**总时间（发送完成时间）** = `0.5 s + 10 s = 10.5 s`。

### 2. 分组交换

- **基本思想**：将数据分割成较小的**分组 (packet)**，每个分组独立传输，采用**存储-转发**机制。
- **工作流程**：
    1. **数据分片**：源端将数据拆分为多个带地址信息的分组。
    2. **存储-转发**：每个路由器接收完整分组后，查找路由表，再转发到下一跳。
    3. **重组**：目的端接收全部分组后，按序重组为原始数据。
- **核心特点**：
    - **资源共享**：链路资源被所有通信动态共享（**统计多路复用**）。
    - **无需预先建立连接**：直接发送数据，无连接建立开销。
    - **适合突发性通信**：仅在发送分组时占用资源。
- **优势与代价**：
    - **优势**：资源利用率高，可支持更多突发性用户。
    - **代价**：可能产生**排队延迟**、**分组丢失**，传输延迟不确定。

**计算示例（存储-转发延迟）**:
- 已知：分组大小 `L = 7.5 Mbits`，链路速率 `R = 1.5 Mbps`。
- 单个节点的存储-转发延迟 = `L / R = 7.5 / 1.5 = 5 s`。
- 若经过3跳，则总传输延迟 = `3 * 5 s = 15 s`（此处仅计算存储-转发延迟，未包括传播延迟）。

---

## 三、电路交换 vs. 分组交换深度对比

| 对比维度 | 电路交换 | 分组交换 |
| :--- | :--- | :--- |
| **资源分配** | **静态固定**，独享带宽 | **动态共享**，统计复用 |
| **建立过程** | 需要**连接建立阶段**（耗时） | **无连接**，直接发送 |
| **适用流量** | 平稳、持续的流量（如语音） | **突发性**、间歇性流量（如网页、数据） |
| **资源效率** | **低**，空闲期资源浪费 | **高**，按需使用 |
| **传输延迟** | **固定且低**（建立后） | **可变**，可能有排队延迟 |
| **可靠性** | 一旦建立，路径稳定 | 路径可能变化，需处理丢包、乱序 |
| **典型应用** | 传统电话网 (PSTN) | 互联网、现代数据网络 |

**定量对比（用户支持数）**：
- 场景：1 Mbps链路，每个用户活跃时需100 kbps，用户活跃概率 `p = 0.1`（10%时间在发数据）。
- **电路交换**：每个用户需独占100 kbps。最大支持用户数 = `1 Mbps / 100 kbps = 10`个。
- **分组交换**：利用统计复用，可支持**远超10个**用户。例如，支持35个用户时，**超过10个用户同时活跃的概率仅为0.04%**，绝大多数时间能满足需求。这体现了分组交换在突发性流量下的巨大容量优势。

---

## 四、网络核心的关键技术与概念

### 1. 转发 vs. 路由
这是网络核心（路由器）的两大基本功能：
- **转发**：一个**局部、瞬时的操作**。路由器根据到达分组的目的地址**查询本地路由表**，决定从哪个输出端口将分组发送出去。
- **路由**：一个**全局、持续的过程**。通过运行**路由算法**（如OSPF, BGP）来生成和维护路由表，确保表项能反映网络拓扑的当前状态。
- **关系**：路由为转发提供“地图”和“决策依据”。

### 2. 排队延迟与分组丢失
- **产生原因**：在分组交换网络中，当多个分组同时需要从同一输出链路转发时，后到的分组需要在**缓冲区（队列）** 中等待。
- **排队延迟**：分组在队列中等待的时间。队列长度动态变化，延迟不确定。
- **分组丢失**：当队列缓冲区被占满时，新到达的分组将因无处存放而被**丢弃**，造成丢失。
- **本质**：这是用**性能的不确定性**换取**资源的高效共享**所带来的必然代价。

---

## 五、分组交换网络的两种实现方式

### 1. 数据报网络
- **核心思想**：**无连接**。每个分组携带完整的**目的地址**，独立地在网络中寻路。
- **特点**：
    - 路由器不维护任何连接状态，只根据每个分组的目的IP地址进行转发。
    - 同一数据流的不同分组**可能走不同路径**，导致乱序。
    - **类比**：就像**邮寄信件**，每封信都写有完整收件人地址，邮局独立处理每封信。
    - **典型代表**：**互联网的IP协议**。

### 2. 虚电路网络
- **核心思想**：**有连接**。通信前需建立一条逻辑上的**虚电路**，所有分组沿此固定路径传输。
- **特点**：
    1. **建立阶段**：发送信令分组，沿途路由器记录连接状态，分配一个**虚电路号**。
    2. **传输阶段**：分组只携带简短的虚电路号，路由器根据此号和转发表进行快速转发。
    3. **拆除阶段**：通信结束，释放虚电路。
    - **类比**：就像**打电话**，先拨号建立连接，然后通话，最后挂断。
    - **典型代表**：ATM、帧中继网络。

| 对比点 | 数据报网络 | 虚电路网络 |
| :--- | :--- | :--- |
| **连接性** | 无连接 | 面向连接 |
| **地址信息** | 每个分组含完整目的地址 | 分组只含简短的虚电路号 |
| **状态维护** | 中间节点**无状态** | 路径上所有节点**维护连接状态** |
| **路径** | 同一数据流的分组路径**可能不同** | 所有分组走**同一固定路径** |
| **可靠性** | 由端系统（TCP）保证 | 可由网络本身提供一定保证 |
| **灵活性** | 对故障适应性强（路径可绕行） | 建立后路径固定，故障影响较大 |

---

## 六、知识小结

| 知识点 | 核心内容 | 重点/易混淆点 | 难度 |
| :--- | :--- | :--- | :--- |
| **网络核心作用** | 由交换节点和链路构成，负责数据交换（转发和路由）。 | 区分交换节点与链路的关系。 | ★★ |
| **电路交换** | 预先建立独占物理线路（如电话网），资源独享，性能有保障但效率低。 | 连接建立时延对短通信不友好；理解TDM/FDM/WDM如何划分资源。 | ★★★ |
| **分组交换** | 数据分组成包，存储转发，资源共享（统计复用）。优势是效率高，代价是排队和丢包。 | **统计复用** vs **固定时分复用**；理解“流量强度=1时系统拥塞”。 | ★★★★ |
| **多路复用技术** | **FDM** (频分)、**TDM** (时分)、**WDM** (波分)用于电路交换；**CDMA** (码分)用于无线接入。 | 区分骨干网（FDM/TDM/WDM）与接入网（CDMA）应用场景。 | ★★★ |
| **数据报 vs 虚电路** | 数据报无连接（类似寄信），虚电路有连接（类似打电话）。 | 虚电路号 vs 完整目标地址；理解状态维护的开销对比。 | ★★★★ |
| **定量分析案例** | 1Mbps链路，用户活跃概率10%。电路交换支持10用户；分组交换可支持35用户（99.96%时间可用）。 | 运用概率模型（二项分布）计算活跃用户超限的概率。 | ★★★★ |

---

> 游神tips：网络核心的两种交换方式是很重要的，也是这一章的重中之重。理解电路交换的“确定性”和分组交换的“统计性”是关键。其差异好如打电话 vs 发微信，并通过计算例题巩固对带宽、延迟等量化概念的理解。



*py大神言：*

- **打电话**追求的是**实时、稳定、高质量的连接**，适合长时间、连续的交流。这对应着对**延迟敏感、需保证带宽**的应用，如**语音通话、视频会议、在线直播**。

- **发微信**追求的是**高效、灵活、低成本的信息传递**，能容忍一定的延迟和顺序问题。这对应着**突发性、间歇性**的数据应用，如**网页浏览、文件传输、即时通讯（文字）**。

| 特性        | 电路交换              | 分组交换**（互联网）**        |
| --------- | ----------------- | -------------------- |
| **哲学**    | **确定性、保障质量**      | **统计性、追求效率**         |
| **生活原型**  | 打电话、租专线           | 发微信、寄快递、所有互联网应用      |
| **资源使用**  | 静态分配、独占           | 动态共享、统计复用            |
| **延迟特性**  | 固定、低              | 可变、可能有排队             |
| **适用场景**  | 传统语音、实时视频、工业控制    | 网页、邮件、文件共享、流媒体（需优化）  |
| **计算关注点** | 连接建立时间 + 固定速率传输时间 | 存储转发延迟 + 排队延迟 + 传播延迟 |
**现代网络的融合趋势**：  
今天的互联网虽然基于分组交换，但对于**电话（VoIP）、视频会议（Zoom）** 等实时应用，会通过一系列复杂技术（如**服务质量QoS、优先级队列、流量整形**）在网络中模拟出“**虚拟的专属车道**”，以保障它们的体验。这可以理解为在分组交换的“公共高速公路”上，为救护车（实时流量）开辟了优先通道。

*游神总结：*

## 一、打电话 vs 发微信

### 场景对比

|对比维度|**打电话（电路交换）**|**发微信（分组交换）**|
|---|---|---|
|**通信前准备**|需要**拨号**，等待对方**接听**，建立通话连接后才能说话。  <br>（**建立连接耗时**）|直接**输入文字/语音**，点击发送即可，无需对方实时准备。  <br>（**无连接建立**）|
|**资源占用**|通话期间，这条线路（包括交换机和链路资源）被**你们两个独占**，即使沉默不说话，别人也无法使用。  <br>（**资源独享，利用率低**）|你的消息被拆成多个“数据包”，和其他千万用户的消息包共享网络通道。  <br>（**资源共享，利用率高**）|
|**传输过程**|声音信号沿着建立的固定路径实时、连续传递。  <br>（**路径固定，低延迟**）|文字/语音被拆包，每个包可能走不同网络路径，到达后再按顺序组装。  <br>（**路径可变，可能有延迟和乱序**）|
|**可靠性**|一旦接通，声音质量稳定（除非线路故障）。  <br>（**连接导向的可靠**）|网络忙时消息可能延迟、丢失（显示红色感叹号），需要重发。  <br>（**尽力而为，可能不可靠**）|
|**费用模式（早期）**|**按通话时长计费**，因为占用了独占的通信资源。  <br>（反映资源成本）|**按流量或包月计费**，因为你只在使用瞬间分享了网络资源。  <br>（反映共享成本）|

---

## 二、从原理看差异

### 1. 电路交换：如同预定专属车道

想象py大神要从A城开车到B城出席ICPC WF，要求绝对不能迟到。

- **做法**：py大神向高速公路公司**预定一条专属车道**，全程只供py使用。
    
- **过程**：
    
    1. **建立连接**：提前电话预约，缴费确认（耗时）。
        
    2. **独占资源**：会议当天，整条车道清空给py，哪怕py车上只有一个人，别人也不能用。
        
    3. **稳定通行**：py以固定速度行驶，到达时间可精确预测。
        
- **缺点**：价格昂贵；如果py因为高精没写出来导致初赛坠机，车道依然空置，资源浪费。


**对应例题计算**：

> **例题**：已知你预定的“专属车道”带宽（通行能力）为 `64 kbps`，你的演讲文件大小为 `640 kb`。你需要提前多久开始传输，才能确保会议开始时文件已送达？
> 
> **计算**：  
> 传输时间 = 文件大小 / 带宽 = `640 kb / 64 kbps = 10 秒`。  
> 再加上预约车道（建立连接）的时间（比如 `0.5 秒`），总需提前 `10.5 秒` 开始。

### 2. 分组交换：如同拼车快递

现在你要把一本300页的本子发给游神，不要求同时到达。

- **做法**：你把本子**拆成30个章节**，每个章节装一个信封，写上地址，交给快递公司。
    
- **过程**：
    
    1. **拆包与发送**：快递公司（路由器）收到每个信封后，看地址，决定下一站。
        
    2. **共享资源**：你的信封和其他成千上万的信封一起，被塞进同一辆快递车（链路），按顺序处理。
        
    3. **排队与延迟**：如果某个中转站（路由器）爆仓，你的信封可能需要排队等待。
        
    4. **重组**：所有信封到达后，游神按页码重新装订成书。
        
- **优点**：便宜，高效利用快递网络。
    
- **缺点**：章节可能走不同路线，导致后发的先到（乱序）；极端情况下可能丢件导致机长。
    

**对应例题计算**：

> **例题**：你的书被拆成10个等大的“数据包”，每个包 `64 kb`。网络中有3个中转站（路由器），每个路由器之间的链路速度为 `1.5 Mbps`。不考虑排队和传播延迟，所有包从发完到收完需要多久？
> 
> **计算（存储转发延迟）**：
> 
> 1. 单个包的传输时间（经过一跳）= 包大小 / 链路速度 = `64 kb / 1.5 Mbps ≈ 0.0427 秒`。
>     
> 2. 第一个包需要经过3跳（A→R1, R1→R2, R2→B），耗时 = `3 * 0.0427 ≈ 0.128 秒` 到达。
>     
> 3. 但所有10个包是连续发送的。计算最后一个包的完成时间：它需要等前9个包都离开A点后，才开始第一跳的传输，然后自己再走3跳。
>     
> 4. **总时间** ≈ `(10 - 1) * 0.0427 + 3 * 0.0427 = 12 * 0.0427 ≈ 0.512 秒`。
>     

*分组交换中“**管道化**”效应带来的效率提升——虽然每个包有延迟，但多个包可以像流水线一样连续传输。*

---

## 三、量化对比：带宽、延迟与效率

用一个更综合的例子感受两种方式在**资源效率**上的根本差异。

**场景**：  
你油有一条 `1 Gbps` 的出口带宽，供学生访问互联网。

- 每个学生在“活跃”时（如下载、看片）平均需要 `10 Mbps` 带宽。
    
- 统计发现，任意时刻平均只有 `10%` 的学生处于“活跃”状态。
    

**问题**：采用不同的交换方式，这条链路能支持多少学生？

1. **若采用“电路交换”思维（如分配固定VPN通道）**
    
    - 每个活跃学生需要独占 `10 Mbps`。
        
    - 最大支持学生数 = 总带宽 / 每用户带宽 = `1000 Mbps / 10 Mbps = 100` 人。
        
    - **弊端**：这100个名额一旦分配，即使学生只在10%的时间活跃，另外90%的时间其带宽也被锁定、闲置，无法给他人用。实际成百上千的其他学生将被拒之门外，饥渴难耐。
        
2. **若采用“分组交换”思维（即实际互联网方式）**
    
    - 所有学生**共享** `1 Gbps` 的总带宽，按需使用。
        
    - 基于统计规律（二项分布），当学生总数 `N` 很大时，同时活跃的用户数基本围绕 `N * 10%` 波动。
        
    - 要保证网络不拥塞（即同时活跃的用户总需求不超过 `1 Gbps`），我们需要：`N * 10% * 10 Mbps ≤ 1000 Mbps` → `N ≤ 1000`。
        
    - **结论**：在可接受的轻微拥塞风险下，这条链路可以轻松支持 **~1000名** 学生！效率是电路交换的**10倍**