# 2.3 文件传输协议 —— FTP

---

## 一、FTP 协议概述

### 1. 什么是 FTP？

**FTP（File Transfer Protocol，文件传输协议）** 是互联网最早、最经典的应用层协议之一，诞生于 **1971 年**（早于 TCP/IP 协议栈），最终标准由 **RFC 959**（1985年）定义。

- **核心功能**：实现**远程主机与本地文件系统之间的双向文件传输**（上传/下载）。
    
- **经典场景**：校园网 FTP 服务器、开源软件镜像站、BBS 资源分享。
    
- **当前地位**：虽被云盘、P2P、HTTP 静态文件服务大量取代，但在**企业内网、嵌入式设备、老旧系统维护**中仍广泛使用。
    

> 💡 **历史意义**：FTP 是**第一个将“控制”与“数据”通道分离**的应用层协议，这种“带外控制”设计影响深远。

---

## 二、FTP 体系结构

### 1. 客户端-服务器模型

|角色|组件|功能|
|---|---|---|
|**FTP 客户端**|用户接口|提供命令行（`ftp>`）或图形界面（如 FileZilla）|
||本地文件系统|存储待上传/已下载的文件|
|**FTP 服务器**|**21 号端口**（控制）|持续监听客户端的控制连接请求|
||文件系统|维护共享目录结构，执行文件读写操作|

### 2. 核心设计：<span style="color: #e67e22;">**双连接机制**</span>

FTP 最大的特点是 **使用两个并行的 TCP 连接**：

|连接类型|端口|方向|传输内容|生命周期|
|---|---|---|---|---|
|**控制连接**|服务器 21|客户端 → 服务器|**ASCII 文本命令/响应**（如 `USER`、`RETR`）|**整个会话期间保持**|
|**数据连接**|服务器 20（主动模式）|服务器 → 客户端（主动）|**文件数据**、**目录列表**|**每次文件传输新建，传输完毕立即关闭**|

#### 🧠 带外控制（Out-of-Band Control）

- 控制信息与数据**分开传输**，互不干扰。
    
- 对比 HTTP：HTTP 的请求/响应头和数据**共用同一 TCP 连接**（**带内控制**）。
    

---

## 三、FTP 工作模式详解

由于 NAT/防火墙的普及，FTP 演化出两种工作模式：

### 1. <span style="color: #3498db;">**主动模式**</span>（PORT Mode）

**流程**：

1. 客户端随机开启一个高位端口（N > 1023），连接服务器 **21 端口** → 建立**控制连接**。
    
2. 客户端通过控制连接发送 `PORT N+1` 命令，告知服务器：“我准备好了数据端口，请连接我的 N+1 端口”。
    
3. 服务器**主动**从自己的 **20 端口**向客户端的 `N+1` 端口发起**新的 TCP 连接** → 建立**数据连接**。
    
4. 文件传输完成后，数据连接关闭；控制连接保持。
    

**⚠️ 问题**：客户端防火墙通常**阻止外网发起的入站连接**（服务器主动连客户端端口会被防火墙拦截），导致主动模式在家庭/办公网络下经常失败。

---

### 2. <span style="color: #2ecc71;">**被动模式**</span>（PASV Mode）

**为了解决防火墙问题，1994 年引入被动模式（RFC 1579）。**

**流程**：

1. 客户端连接服务器 21 端口 → 建立**控制连接**。
    
2. 客户端发送 `PASV` 命令，请求进入被动模式。
    
3. 服务器开启一个**临时随机端口**（P > 1023），并通过控制连接返回 `227 Entering Passive Mode (h1，h2，h3，h4，p1，p2)`。
    
4. 客户端**主动**连接服务器的 `P` 端口 → 建立**数据连接**。
    
5. 文件传输完成后，数据连接关闭。
    

**✅ 优势**：**数据连接也由客户端发起**，完美穿越客户端防火墙/NAT。**现代 FTP 客户端默认使用被动模式**。

|模式|数据连接发起方|防火墙友好性|应用场景|
|---|---|---|---|
|主动|**服务器**（连客户端）|❌ 差|服务器与客户端在同一内网|
|被动|**客户端**（连服务器）|✅ 好|**绝大多数互联网场景**|

---

## 四、FTP 命令与响应

FTP 命令和响应均为 **ASCII 明文**，通过控制连接传输。

### 1. 常用 FTP 命令

|命令|参数|含义|示例|
|---|---|---|---|
|`USER`|用户名|发送用户名|`USER anonymous`|
|`PASS`|密码|发送密码|`PASS guest@`|
|`LIST`|[目录名]|请求返回目录文件列表|`LIST`|
|`RETR`|文件名|**下载**文件（Retrieve）|`RETR readme.txt`|
|`STOR`|文件名|**上传**文件（Store）|`STOR report.pdf`|
|`CWD`|目录路径|切换工作目录（Change Working Directory）|`CWD /pub/linux`|
|`PWD`|无|显示当前目录|`PWD`|
|`QUIT`|无|退出连接|`QUIT`|

> 📌 **术语约定**：**上传** = 客户端 → 服务器；**下载** = 服务器 → 客户端。始终以客户端为参照系。

### 2. FTP 响应状态码

FTP 响应码为 **3 位数字**，与 HTTP 风格相似，但细节不同：

|状态码|含义|示例|
|---|---|---|
|**1xx**|肯定预备状态（操作已开始）|`125 Data connection already open`|
|**2xx**|成功|`200 Command okay`|
|**3xx**|需要进一步信息|`331 User name okay， need password`|
|**4xx**|临时错误（可重试）|`425 Can‘t open data connection`|
|**5xx**|永久错误|`530 Not logged in`|

**典型登录交互**：


```text

Client: USER alice
Server: 331 Password required for alice
Client: PASS secret
Server: 230 User alice logged in
```
---

## 五、FTP 的缺陷与安全演进

### 1. <span style="color: #c0392b;">**核心缺陷：明文传输**</span>

- **所有命令**（包括 `USER`/`PASS`）和**文件数据**均**未经加密**，直接通过 TCP 传输。
    
- **风险**：
    
    - 在共享网络（如校园网、咖啡厅 Wi-Fi）中，攻击者可轻松抓包获取**用户名、密码**及传输的文件内容。
        
    - 存在**中间人攻击**（篡改文件、注入恶意代码）。
        

### 2. 安全增强方案

| 方案                                   | 技术原理                       | 特点                                   | 典型端口           |
| ------------------------------------ | -------------------------- | ------------------------------------ | -------------- |
| **FTPS**（FTP over SSL/TLS）           | 在控制连接和数据连接外层包裹 SSL/TLS 加密  | **显式 SSL**（AUTH TLS）或**隐式 SSL**（990） | 990（隐式）、21（显式） |
| **SFTP**（SSH File Transfer Protocol） | **基于 SSH 2.0**，不是 FTP 的扩展！ | 单连接、加密、集成 SSH 认证                     | 22             |
| **SCP**                              | 基于 SSH 的简单文件复制             | 仅支持下载/上传，无目录浏览                       | 22             |
|                                      |                            |                                      |                |

**📌 现实**：**SFTP** 因安全性高、配置简单，已逐渐取代传统 FTP。但 FTPS 仍保留于某些合规要求高的场景。

---

## 六、FTP vs HTTP —— 协议设计对比

|对比维度|FTP|HTTP|
|---|---|---|
|**连接数量**|**2 个**（控制 + 数据）|**1 个**（所有信息复用同一连接）|
|**控制方式**|**带外控制**（控制信息与数据分离）|**带内控制**（请求头/响应头与数据同一流）|
|**状态性**|**有状态协议**（服务器需记录用户目录、认证状态）|**无状态协议**（每个请求独立）|
|**传输效率**|多次文件传输需多次建立数据连接（耗时）|持久连接 + 流水线（HTTP/1.1+）|
|**典型用途**|大批量文件管理（上传/下载/删除/重命名）|Web 页面、API 接口、静态资源分发|
|**防火墙穿透**|被动模式解决，但仍有复杂性|单一端口（80/443），天然友好|

**💡 核心差异总结**：

- FTP 是 **“远程文件系统操作协议”**（你可以像操作本地文件一样 `ls`、`cd`、`rm`）。
    
- HTTP 是 **“资源获取协议”**（本质是 `GET` 文件）。
    

---

## 七、知识小结（精华速查表）

|知识点|核心内容|考试重点/易混淆点|难度|
|---|---|---|---|
|**FTP 作用**|远程文件上传/下载，早期互联网文件共享主流|区分上传/下载方向（客户端视角）|★★|
|**双连接机制**|**控制连接**（21/TCP，整个会话）  <br>**数据连接**（20/TCP 主动模式，临时端口被动模式）|**必须牢记端口号**，理解“带外控制”|★★★★|
|**主动模式**|服务器从 20 端口主动连客户端数据端口|**防火墙不友好**，需客户端允许入站|★★★|
|**被动模式**|服务器开放临时端口，客户端主动连接|**现代默认模式**，解决 NAT 穿透|★★★|
|**FTP 命令**|`USER`、`PASS`、`LIST`、`RETR`、`STOR`、`CWD`、`QUIT`|`RETR` = 下载，`STOR` = 上传|★★★|
|**响应码**|1xx预备、2xx成功、3xx需认证、4xx临时错、5xx永久错|常见：`331`需密码，`530`登录失败|★★★|
|**安全缺陷**|**明文传输**（口令、数据均可被嗅探）|与 **SFTP**（基于 SSH）**严格区分**|★★★★|
|**FTPS vs SFTP**|FTPS = FTP + SSL/TLS  <br>SFTP = 基于 SSH 2.0 的新协议|**不是同一种技术！** 端口也不同|★★★★|
|**与 HTTP 对比**|FTP：**有状态、双连接、带外控制**  <br>HTTP：**无状态、单连接、带内控制**|面试/考试高频对比题|★★★★★|

---

## 八、延伸思考：FTP 为何未彻底消失？

尽管 FTP 存在诸多缺陷，它仍在以下领域保持生命力：

1. **遗留系统维护**：银行、政府、制造业的旧系统深度绑定 FTP 脚本。
    
2. **嵌入式设备**：网络打印机、工业控制器常内置轻量级 FTP 服务器用于固件升级。
    
3. **批量文件交换**：某些 B2B 交易平台仍要求通过 FTP 定时交换 CSV 数据文件。
    
4. **内网高速传输**：无加密开销，纯内网环境可跑满带宽。
    

**学习 FTP 的真正价值**：

- 它是理解“**应用层协议如何设计**”的绝佳案例（状态管理、多连接协调）。
    
- 为后续学习 **P2P、多媒体协议、CDN** 等复杂协议打下基础。
    

> 📖 **“控制与数据分离”思想** 后来被许多协议借鉴，例如 **SIP（会话初始协议）** 分离信令与媒体流、**WebRTC** 分离信令与音视频数据。