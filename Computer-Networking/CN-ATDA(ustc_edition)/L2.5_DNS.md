# 2.5 DNS —— 域名系统

---

## 一、DNS 概述：互联网的“电话本”

### 1. 为什么需要 DNS？

**IP 地址**是网络设备的唯一标识（如 `202.38.64.1`），但人类**不擅长记忆**无意义的数字串。  
**域名**（Domain Name）是有意义的字符串（如 `www.ustc.edu.cn`），便于记忆和使用。

**DNS（Domain Name System）** 的核心任务：**将域名“翻译”成对应的 IP 地址**。

### 2. DNS 的特殊地位

- **基础设施型应用**：DNS 不为终端用户直接操作，而是**被其他应用调用**（如 HTTP、FTP、SMTP）。
    
- **运行在应用层**：基于 **UDP 53 端口**（事务型查询），也支持 TCP（区域传输）。
    
- **分布式、层次化数据库**：全球数万台服务器协同工作，无单点故障。
    

---

## 二、从“单机 HOSTS”到“分布式 DNS”

### 1. ARPANET 早期方案：集中式 HOSTS.TXT

- 所有主机名与 IP 的映射保存在一个名为 **`HOSTS.TXT`** 的中央文件中。
    
- 由 SRI（斯坦福研究所）**集中维护**，各站点定期通过 FTP 下载更新。
    
- **问题**：
    
    - 单点故障风险（服务器宕机 → 全网络无法解析）
        
    - 流量与负载集中（全球所有查询涌向一台机器）
        
    - 命名冲突（平面结构，无法保证全局唯一）
        
    - 更新延迟（新增主机需等待全量文件同步）
        

> 💡 **1983年，Paul Mockapetris 设计了 DNS，彻底解决了上述问题。**

---

## 三、DNS 核心设计之一：层次化命名空间

### 1. 域名结构

DNS 采用**树状结构**，根在顶端，向下分支。


```text

根 (.)
├── 顶级域 (TLD)
│   ├── 通用域 (com, org, net, edu...)
│   └── 国家域 (cn, uk, jp...)
│       └── 二级域 (ustc, mit, ibm...)
│           └── 三级域 (cs, ee, mail...)
│               └── 主机名 (www, ftp, dns...)
```
**域名书写规则**：从树叶到树根，用点分隔。  
例如：`www.cs.ustc.edu.cn.`（最后的点表示根，通常省略）。

**特性**：

- **全球唯一性**：由父域保证子域名不重复。
    
- **逻辑划分**：域与物理网络无关，同一域的主机可分布在全球。
    

### 2. 域与区域

- **域**（Domain）：树上的一个节点及其所有子节点。
    
- **区域**（Zone）：**被授权管理**的连续子树。一个区域可以包含多个域，也可以将一个子域委托给其他服务器管理。
    

**例子**：

- `ustc.edu.cn` 是一个域。
    
- 学校可以将 `cs.ustc.edu.cn` 子域**委托**给计算机系独立管理，此时 `cs.ustc.edu.cn` 成为一个**独立区域**。
    

---

## 四、DNS 核心设计之二：分布式数据库与权威服务器

### 1. 权威名字服务器

每个区域**至少有一台**权威名字服务器（Authoritative Name Server），负责维护该区域内所有域名→IP的映射，并响应查询。

**权威记录**：由区域管理员配置，**绝对准确**，TTL 通常设为无限大（但缓存时会设置有限 TTL）。

### 2. 区域划分与委托

**父域**需要记录指向**子域权威服务器**的指针（即 NS 记录 + A 记录）。  
例如：`.cn` 域必须知道 `edu.cn` 的权威服务器是谁；`edu.cn` 必须知道 `ustc.edu.cn` 的权威服务器是谁。

**这就是“逐级委托”机制**——查询从根开始，一级一级向下寻找，最终到达目标区域的权威服务器。

---

## 五、DNS 资源记录 —— 数据库的“数据单元”

所有 DNS 信息以**资源记录**（Resource Record，RR）的形式存储。格式如下：

```text

（域名， TTL， 类型， 类， 值）
```
- **TTL**：生存时间（秒），权威记录可设为 0（不缓存），缓存记录通常 2 天。
    
- **类**：几乎总是 **IN**（Internet）。
    
- **类型**：指明本条记录的功能。
    

|记录类型|全称|作用|示例|
|---|---|---|---|
|**A**|Address|域名 → IPv4 地址|`www.ustc.edu.cn. IN A 202.38.64.10`|
|**AAAA**|IPv6 Address|域名 → IPv6 地址|`www.ustc.edu.cn. IN AAAA 2001:da8::1`|
|**CNAME**|Canonical Name|别名 → 规范名|`mail.ustc.edu.cn. IN CNAME mx.ustc.edu.cn.`|
|**NS**|Name Server|域 → 权威服务器域名|`ustc.edu.cn. IN NS dns.ustc.edu.cn.`|
|**MX**|Mail eXchange|邮件交换器 → 服务器域名（含优先级）|`ustc.edu.cn. IN MX 10 mx.ustc.edu.cn.`|
|**PTR**|Pointer|IP 地址 → 域名（反向解析）|`1.168.192.in-addr.arpa. IN PTR host.example.com.`|
|**SOA**|Start of Authority|区域权威信息（序列号、刷新间隔等）|（每个区域唯一）|

> 📌 **重点**：NS 记录只给出**服务器域名**，要获取其 IP 地址，必须有对应的 **A 记录**（粘附记录，glue record）。否则会形成死循环。

---

## 六、DNS 解析过程：递归与迭代

### 1. 本地名字服务器

每个客户端（PC、手机）在接入网络时，会获得一个**本地 DNS 服务器**（Local DNS）的 IP 地址（通常由 DHCP 自动分配，如 `8.8.8.8` 或 `114.114.114.114`）。

**优势**：

- 位于同一子网或相近位置，**延迟低**。
    
- **缓存功能**：存储近期查询结果，大幅提升效率。
    

### 2. 两种查询模式

|模式|工作方式|优缺点|
|---|---|---|
|**递归查询**|客户端 → Local DNS → 根 → … → 权威 → 逐层返回结果。**Local DNS 承担全部查询任务**。|对客户端透明，但根服务器压力大（“杜甫很忙”）。|
|**迭代查询**|客户端 → Local DNS → 根（返回下一级指引）→ TLD 服务器（返回指引）→ … → 权威（返回答案）。**Local DNS 逐级“问路”**。|分散负载，更健壮。**实际互联网中 Local DNS 通常采用迭代查询**。|

**典型解析流程（以 `www.cs.ustc.edu.cn` 为例，迭代查询）**：

```text

1. 浏览器 → Local DNS：“www.cs.ustc.edu.cn 的 IP？”
2. Local DNS → 根服务器（.）：“.cn 的 NS 是？”
   根回复：“.cn 的 NS 是 a.dns.cn；IP 是 …”
3. Local DNS → .cn 服务器：“.edu.cn 的 NS 是？”
   .cn 回复：“.edu.cn 的 NS 是 c.edu.cn；IP …”
4. Local DNS → .edu.cn 服务器：“.ustc.edu.cn 的 NS 是？”
   .edu.cn 回复：“.ustc.edu.cn 的 NS 是 dns.ustc.edu.cn；IP …”
5. Local DNS → dns.ustc.edu.cn：“www.cs.ustc.edu.cn 的 A 记录？”
   权威回复：“A 202.38.64.10”
6. Local DNS 缓存结果，返回给浏览器。
```
### 3. 缓存机制

- **本地 DNS 服务器** 缓存所有查询过的非权威答案。
    
- **浏览器**、**操作系统** 也有自己的 DNS 缓存（如 Chrome 内置 DNS 缓存）。
    
- **TTL 到期**后自动删除，保证一致性。
    

> 💡 **正是缓存，使 DNS 可扩展**：根服务器日均查询量虽大，但**绝大多数请求在 Local DNS 处就被缓存命中**，真正到达根的流量远少于理论值。

---

## 七、DNS 报文格式

DNS 查询和响应使用**相同的报文格式**，通过标志位区分。

```text

+---------------------+
|       Header        | 12 字节（固定）
+---------------------+
|     Question        | 查询问题（可变）
+---------------------+
|      Answer         | 回答 RR（可变）
+---------------------+
|    Authority        | 权威 NS 记录（可变）
+---------------------+
|    Additional       | 附加信息（如 glue A 记录）（可变）
+---------------------+
```
**头部关键字段**：

- **ID**（16 bit）：标识符，**用于匹配查询与响应**。支持**流水线**（pipelining）。
    
- **QR**（1 bit）：0=查询，1=响应。
    
- **Opcode**：0=标准查询，1=反向查询，2=服务器状态请求。
    
- **AA**（Authoritative Answer）：响应中置 1，表示答案来自权威服务器。
    
- **RD**（Recursion Desired）：查询中置 1，表示希望递归。
    
- **RA**（Recursion Available）：响应中置 1，表示服务器支持递归。
    
- **rcode**（4 bit）：返回码（0=无差错，3=域名不存在，等）。
    

> 📌 **DNS 使用 UDP 53 端口传输查询/响应**（单个报文 ≤ 512 字节）。若响应超长，则改用 TCP 53。

---

## 八、DNS 维护：如何新增一个域？

假设你想创建一个新域 `networktopia.com`，流程如下：

1. **向域名注册机构**（如 GoDaddy、万网）申请注册。
    
2. 注册机构在 **`.com` 顶级域的权威服务器**中，**插入两条记录**：
    
    ```text
    
    networktopia.com.  NS   ns1.networktopia.com.
    networktopia.com.  NS   ns2.networktopia.com.
    ns1.networktopia.com.  A   203.0.113.1
    ns2.networktopia.com.  A   203.0.113.2
    ```
    - NS 记录：告知全世界，`networktopia.com` 的权威服务器是 `ns1` 和 `ns2`。
        
    - A 记录：**粘附记录**（glue），用于解析 NS 服务器本身的 IP 地址。
        
3. 在你自己的服务器上**运行 DNS 服务**，并配置 `networktopia.com` 区域文件，包含下属主机（如 `www`、`mail`）的 A 记录。
    
4. 互联网用户第一次查询 `www.networktopia.com` 时，会从 `.com` 服务器获得 NS 和 glue，然后向你的权威服务器获取最终 IP。
    

---

## 九、DNS 安全与可靠性

### 1. DNS 面临的主要攻击

|攻击类型|描述|防御措施|
|---|---|---|
|**DDoS 攻击**|向根/TLD 服务器发送海量流量，试图使其瘫痪。|任播（Anycast）部署、流量清洗、防火墙。**根服务器极为健壮**，未发生过因 DDoS 导致的全局瘫痪。|
|**缓存中毒**|向 DNS 服务器发送伪造的响应，使其缓存虚假记录。|**DNSSEC**（数字签名验证）、随机化源端口、随机化查询 ID。|
|**中间人攻击**|在查询路径中截获并篡改报文。|使用 **DNS over TLS**（DoT）、**DNS over HTTPS**（DoH）加密传输。|
|**域名劫持**|攻破注册机构，篡改 NS 记录指向恶意服务器。|注册锁、双因素认证、定期审计。|

### 2. DNS 的可靠性设计

- **冗余**：每个区域至少 2 台权威服务器，分布在不同的网络。
    
- **缓存**：即使根服务器全部瘫痪，**本地 DNS 已缓存的顶级域 NS 记录**仍可维持数天解析服务。
    
- **任播**：全球 13 个根服务器的“逻辑节点”，背后有**上千台物理服务器**通过任播共享同一 IP，任意一台被攻击不影响整体。
    

> 💡 **误解澄清**：中国没有根服务器**物理镜像**，但中国用户仍能正常访问互联网，因为：
> 
> - 本地 DNS 缓存了大量 TLD/权威服务器 IP。
>     
> - 查询根服务器的流量本身不大，跨海延迟可接受。
>     
> - 许多递归服务器配置了**根提示**（root hint），仍可正常工作。
>     

---

## 十、DNS 的扩展功能：不止于“域名→IP”

### 1. 负载均衡

大型网站（如 `www.ibm.com`）通常对应**多个 IP 地址**（不同服务器）。DNS 权威服务器**每次轮询返回不同 IP**，实现简单的负载均衡。

### 2. 智能解析 / 地域路由

根据客户端源 IP 的地理位置，返回**最近的数据中心 IP**。例如：

- 中国用户查询 → 返回北京机房的 IP
    
- 美国用户查询 → 返回加州机房的 IP
    

### 3. 邮件服务器定位

MX 记录**不仅给出邮件服务器域名，还包含优先级**。发送方优先尝试优先级数值小的服务器。

### 4. 别名扩展

CNAME 记录允许将多个域名指向同一个规范名，便于管理。  
例如：

```text

wap.example.com.  CNAME  www.example.com.
m.example.com.    CNAME  www.example.com.
```
---

## 十一、知识小结（精华速查表）

|知识点|核心内容|考试重点/易混淆点|难度|
|---|---|---|---|
|**DNS 作用**|域名 → IP 地址转换，及其他元数据查询（MX、CNAME 等）。|**基础设施应用**，不为终端用户直接操作。|★★|
|**域名结构**|树状层次，从叶到根书写，点分隔。|**域 vs 区域**：域是逻辑命名，区域是管理单元。|★★★|
|**分布式架构**|通过**区域委托**和**权威服务器**实现全球无中心管理。|**NS 记录**委托，**A 记录**（glue）解决服务器自引用。|★★★★|
|**资源记录**|A、AAAA、CNAME、NS、MX、PTR、SOA 等。|MX 含优先级，CNAME 不能与其他记录共存。|★★★|
|**解析过程**|递归查询（客户端 → Local → 逐层） vs **迭代查询（Local → 根 → … → 权威）**。|**Local DNS 是关键**，负责缓存和迭代。|★★★★|
|**缓存**|TTL 控制有效期；非权威应答。|**权威记录 TTL 可设 0**（不缓存），缓存记录到期删除。|★★★|
|**DNS 报文**|固定头部（ID、标志位）+ 可变 RR 区。|**ID 号匹配请求/响应**，支持流水线。|★★★|
|**新增域**|在父域注册机构插入 NS + glue 记录。|**必须提供权威服务器 IP**（粘附记录）。|★★★★|
|**安全威胁**|缓存中毒、DDoS、劫持。|DNSSEC、DoT/DoH 是主要防御手段。|★★★|
|**可靠性**|冗余 + 缓存 + 任播。|**根服务器不是查询必经之路**。|★★★★|
|**扩展应用**|负载均衡、地域路由、CDN 调度。|DNS 返回不同 IP 实现**简单流量分配**。|★★★|

---

## 十二、总结

DNS 是互联网的“寻址系统”，其**层次化命名**、**分布式数据库**、**高效缓存**三大设计，支撑了全球数以百亿计的终端设备。

**理解 DNS，就是理解互联网如何可扩展**：

- 没有单点故障；
    
- 查询压力被逐级消化；
    
- 新增域名无需全局协调。
    

当你下一次在浏览器输入网址，瞬间打开网页时，请记得：背后有无数 DNS 服务器协同工作，在毫秒级内完成了人类记忆符号到机器数字地址的华丽转换。