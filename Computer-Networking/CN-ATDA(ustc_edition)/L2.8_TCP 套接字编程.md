# 2.8 TCP å¥—æ¥å­—ç¼–ç¨‹ â€”â€” åº”ç”¨å±‚ä¸ä¼ è¾“å±‚çš„æ¡¥æ¢

---

## ä¸€ã€å¥—æ¥å­—ç¼–ç¨‹æ¦‚è¿°

**å¥—æ¥å­—ï¼ˆSocketï¼‰**Â æ˜¯åº”ç”¨å±‚ä¸ä¼ è¾“å±‚ä¹‹é—´çš„**æŠ½è±¡æ¥å£**ï¼Œå®ƒåƒä¸€ä¸ªâ€œé—¨æˆ·â€ï¼Œåº”ç”¨è¿›ç¨‹é€šè¿‡å®ƒå‘å†…æ ¸åè®®æ ˆå‘é€æˆ–æ¥æ”¶æ•°æ®ã€‚åœ¨ TCP/IP ä½“ç³»ä¸­ï¼Œå¥—æ¥å­—æ˜¯ç½‘ç»œç¼–ç¨‹çš„åŸºç¡€ã€‚

---

## äºŒã€TCP å¥—æ¥å­—åŸºç¡€

### 1. ä»€ä¹ˆæ˜¯ TCP å¥—æ¥å­—ï¼Ÿ

- **æœ¬è´¨**ï¼šä¸€ä¸ªæ•´æ•°ï¼ˆæè¿°ç¬¦ï¼‰ï¼Œç±»ä¼¼äºæ–‡ä»¶å¥æŸ„ï¼Œä»£è¡¨è¿›ç¨‹ä¸å†…æ ¸ä¸­ TCP åè®®å®ä½“ä¹‹é—´çš„çº¦å®šå…³ç³»ã€‚
    
- **å”¯ä¸€æ ‡è¯†**ï¼šæ¯ä¸ª TCP è¿æ¥ç”±Â **å››å…ƒç»„**Â å”¯ä¸€ç¡®å®šï¼š
    
    text
    
    ï¼ˆæœ¬åœ° IPï¼Œ æœ¬åœ°ç«¯å£ï¼Œ å¯¹æ–¹ IPï¼Œ å¯¹æ–¹ç«¯å£ï¼‰
    
- **æµå¼ç‰¹æ€§**ï¼š
    
    - æä¾›Â **å¯é çš„å­—èŠ‚æµ**Â æœåŠ¡ï¼Œä¸ç»´æŠ¤æŠ¥æ–‡è¾¹ç•Œã€‚
        
    - ä¾‹å¦‚ï¼Œä¸¤æ¬¡ 15KB çš„Â `send()`Â å¯èƒ½è¢«åˆå¹¶ä¸º 30KB çš„å—ç”±Â `recv()`Â ä¸€æ¬¡è¯»å‡ºã€‚
        

### 2. TCP å¥—æ¥å­—ç±»å‹

|å¥—æ¥å­—ç±»å‹|ä½œç”¨|äº§ç”Ÿæ–¹å¼|ç”Ÿå‘½å‘¨æœŸ|
|---|---|---|---|
|**æ¬¢è¿å¥—æ¥å­—**ï¼ˆWelcome Socketï¼‰|ç›‘å¬è¿æ¥è¯·æ±‚ï¼Œä¸ç”¨äºæ•°æ®ä¼ è¾“|`socket()`Â â†’Â `bind()`Â â†’Â `listen()`|æœåŠ¡å™¨æ•´ä¸ªè¿è¡ŒæœŸé—´ä¸€ç›´å­˜åœ¨|
|**è¿æ¥å¥—æ¥å­—**ï¼ˆConnection Socketï¼‰|ä¸ç‰¹å®šå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®ä¼ è¾“|`accept()`Â è¿”å›|å¯¹åº”å®¢æˆ·ç«¯ä¼šè¯æœŸé—´å­˜åœ¨ï¼Œä¼šè¯ç»“æŸå…³é—­|

---

## ä¸‰ã€TCP å¥—æ¥å­—ç¼–ç¨‹æ¨¡å‹

### 1. æœåŠ¡å™¨ç«¯æµç¨‹

```mermaid
flowchart TD
    A["åˆ›å»º welcome socket socket()"] --> B["ç»‘å®šæœ¬åœ°åœ°å€å’Œç«¯å£ bind()"]
    B --> C["è®¾ç½®ç›‘å¬é˜Ÿåˆ— listen()"]
    C --> D{"å¾ªç¯æ¥å—è¿æ¥"}
    D --> E["é˜»å¡äº accept() ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥"]
    E --> F["æ¥å—æˆåŠŸ è¿”å› connection socket"]
    F --> G["åˆ›å»ºå­è¿›ç¨‹/çº¿ç¨‹å¤„ç†è¯¥è¿æ¥"]
    G --> H["åœ¨ connection socket ä¸Š recv()/send() äº¤æ¢æ•°æ®"]
    H --> I["å…³é—­ connection socket close()"]
    I --> D
```
**å…³é”®æ­¥éª¤**ï¼š

- `socket()`ï¼šåˆ›å»ºä¸€ä¸ª TCP å¥—æ¥å­—ï¼ˆæŒ‡å®šÂ `SOCK_STREAM`ï¼‰ã€‚
    
- `bind()`ï¼šå°†å¥—æ¥å­—ä¸æœåŠ¡å™¨çš„ IP åœ°å€å’Œç«¯å£å·ç»‘å®šã€‚è‹¥ä¸ç»‘å®šï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸´æ—¶ç«¯å£ï¼ˆæœåŠ¡å™¨é€šå¸¸éœ€è¦çŸ¥åç«¯å£ï¼‰ã€‚
    
- `listen()`ï¼šå°†å¥—æ¥å­—è½¬ä¸ºè¢«åŠ¨ç›‘å¬æ¨¡å¼ï¼Œå‚æ•°æŒ‡å®šå·²å®Œæˆé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼ˆå¦‚ 10ï¼‰ã€‚
    
- `accept()`ï¼šä»å·²å®Œæˆè¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿æ¥ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„Â **è¿æ¥å¥—æ¥å­—**ã€‚æ­¤åçš„æ•°æ®æ”¶å‘éƒ½é€šè¿‡è¯¥è¿æ¥å¥—æ¥å­—ã€‚
    
- æ•°æ®äº¤æ¢ï¼šä½¿ç”¨Â `read()`Â /Â `write()`Â æˆ–Â `recv()`Â /Â `send()`ã€‚
    
- `close()`ï¼šå…³é—­è¿æ¥å¥—æ¥å­—ï¼ˆé‡Šæ”¾èµ„æºï¼‰ï¼›æ¬¢è¿å¥—æ¥å­—é€šå¸¸ç»§ç»­å­˜åœ¨ã€‚
    

> ğŸ’¡Â **æ³¨æ„**ï¼š`accept()`Â æ˜¯Â **é˜»å¡**Â çš„ï¼Œè‹¥æ— è¿æ¥è¯·æ±‚ï¼Œè¿›ç¨‹ä¼šæŒ‚èµ·ç­‰å¾…ã€‚

---

### 2. å®¢æˆ·ç«¯æµç¨‹

```mermaid
flowchart TD
    A["åˆ›å»º socket\nsocket()"] --> B["è·å–æœåŠ¡å™¨ IP/ç«¯å£"]
    B --> C["è¿æ¥æœåŠ¡å™¨\nconnect()"]
    C --> D{"è¿æ¥æˆåŠŸï¼Ÿ"}
    D -- æ˜¯ --> E["é€šè¿‡ socket\nsend()/recv() äº¤æ¢æ•°æ®"]
    D -- å¦ --> F["é”™è¯¯å¤„ç†"]
    E --> G["å…³é—­ socket\nclose()"]
```
**å…³é”®æ­¥éª¤**ï¼š

- `socket()`ï¼šåˆ›å»ºä¸€ä¸ª TCP å¥—æ¥å­—ã€‚
    
- è·å–æœåŠ¡å™¨åœ°å€ï¼šé€šå¸¸é€šè¿‡åŸŸåè§£æï¼ˆ`gethostbyname()`ï¼‰è·å¾— IPï¼Œç«¯å£ç”±ç”¨æˆ·æŒ‡å®šã€‚
    
- `connect()`ï¼šå‘æœåŠ¡å™¨å‘èµ·è¿æ¥è¯·æ±‚ï¼Œè§¦å‘ TCP ä¸‰æ¬¡æ¡æ‰‹ã€‚æ­¤å‡½æ•°ä¹Ÿæ˜¯é˜»å¡çš„ï¼Œç›´åˆ°è¿æ¥å»ºç«‹æˆåŠŸæˆ–è¶…æ—¶å¤±è´¥ã€‚
    
- æ•°æ®äº¤æ¢ï¼šä½¿ç”¨Â `send()`Â /Â `recv()`Â è¿›è¡Œé€šä¿¡ã€‚
    
- `close()`ï¼šå…³é—­å¥—æ¥å­—ï¼Œå‘èµ· TCP å››æ¬¡æŒ¥æ‰‹ã€‚
    

> ğŸ’¡ å®¢æˆ·ç«¯ä¸€èˆ¬ä¸éœ€è¦Â `bind()`ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸´æ—¶ç«¯å£ã€‚

---

### 3. å…¸å‹äº¤äº’æ—¶åºï¼ˆä»¥â€œå¤§å°å†™è½¬æ¢â€æœåŠ¡ä¸ºä¾‹ï¼‰

```mermaid
sequenceDiagram
    participant Client
    participant Server
    Server->>Server: socket(), bind(), listen()
    Note right of Server: ç­‰å¾…è¿æ¥ï¼ˆé˜»å¡äº acceptï¼‰
    Client->>Client: socket()
    Client->>Server: connect()
    Server-->>Client: accept() è¿”å› connection socket
    Note over Client,Server: TCP ä¸‰æ¬¡æ¡æ‰‹å®Œæˆ
    Client->>Server: send() å°å†™å­—ç¬¦ä¸²
    Server->>Server: è½¬æ¢ä¸ºå¤§å†™
    Server->>Client: send() å¤§å†™å­—ç¬¦ä¸²
    Client->>Client: æ˜¾ç¤ºç»“æœ
    Client->>Server: close()
    Server->>Client: close()
    Note over Client,Server: TCP å››æ¬¡æŒ¥æ‰‹
```
---

## å››ã€å…³é”®æ•°æ®ç»“æ„

### 1.Â `struct sockaddr_in`Â â€”â€” IPv4 åœ°å€ç»“æ„

```c

struct sockaddr_in {
    sa_family_t    sin_family;   // åœ°å€æ—ï¼ŒAF_INETï¼ˆIPv4ï¼‰
    in_port_t      sin_port;     // ç«¯å£å·ï¼ˆ16ä½ï¼Œç½‘ç»œå­—èŠ‚åºï¼‰
    struct in_addr sin_addr;     // IPv4 åœ°å€ï¼ˆ32ä½ï¼‰
    char           sin_zero[8];  // å¡«å……å­—æ®µï¼Œä½¿ä¸ sockaddr å¤§å°ä¸€è‡´
};
```
**ç”¨é€”**ï¼šå­˜å‚¨ IP åœ°å€å’Œç«¯å£å·çš„æ†ç»‘ä¿¡æ¯ï¼Œåœ¨Â `bind()`ã€`connect()`Â ç­‰å‡½æ•°ä¸­ä¼ é€’ã€‚

**å…³é”®ç‚¹**ï¼š

- `sin_port`Â å’ŒÂ `sin_addr`Â å¿…é¡»ä½¿ç”¨Â **ç½‘ç»œå­—èŠ‚åº**ï¼ˆå¤§ç«¯ï¼‰ã€‚
    
- `sin_zero`Â ä»…ç”¨äºå¯¹é½ï¼Œå¿…é¡»å…¨éƒ¨ç½®é›¶ï¼ˆé€šå¸¸ç”¨Â `memset`Â æ¸…é›¶ï¼‰ã€‚
    
- ä½¿ç”¨æ—¶éœ€å¼ºåˆ¶è½¬æ¢ä¸ºÂ `struct sockaddr *`ã€‚
    

---

### 2.Â `struct hostent`Â â€”â€” ä¸»æœºä¿¡æ¯ç»“æ„

```c

struct hostent {
    char  *h_name;            // ä¸»æœºçš„è§„èŒƒå
    char **h_aliases;         // åˆ«ååˆ—è¡¨ï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼‰
    int    h_addrtype;        // åœ°å€ç±»å‹ï¼ŒAF_INET
    int    h_length;          // åœ°å€é•¿åº¦ï¼ŒIPv4 ä¸º 4
    char **h_addr_list;       // IP åœ°å€åˆ—è¡¨ï¼ˆç½‘ç»œå­—èŠ‚åºï¼‰
};
```
**ç”¨é€”**ï¼š`gethostbyname()`Â ç­‰åŸŸåè§£æå‡½æ•°çš„è¿”å›å€¼ï¼Œå­˜å‚¨è§£æå‡ºçš„ IP åœ°å€ç­‰ä¿¡æ¯ã€‚

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```c

struct hostent *p = gethostbyname("www.example.com");
if (p != NULL) {
    memcpy(&sad.sin_addr, p->h_addr, p->h_length);
}
```
---

## äº”ã€ç½‘ç»œå­—èŠ‚åºè½¬æ¢

ä¸åŒä¸»æœºå¯èƒ½é‡‡ç”¨Â **å¤§ç«¯**ï¼ˆBig-Endianï¼‰æˆ–Â **å°ç«¯**ï¼ˆLittle-Endianï¼‰å­—èŠ‚åºï¼Œä¸ºä¿è¯ç½‘ç»œä¼ è¾“ä¸€è‡´æ€§ï¼Œè§„å®šä½¿ç”¨Â **å¤§ç«¯å­—èŠ‚åº**ï¼ˆç½‘ç»œå­—èŠ‚åºï¼‰ã€‚

|å‡½æ•°|ä½œç”¨|
|---|---|
|`htons()`|å°† 16 ä½æ•´æ•°ä»Â **ä¸»æœºå­—èŠ‚åº**Â è½¬æ¢ä¸ºÂ **ç½‘ç»œå­—èŠ‚åº**ï¼ˆhost to network shortï¼‰|
|`htonl()`|å°† 32 ä½æ•´æ•°ä»ä¸»æœºå­—èŠ‚åºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº|
|`ntohs()`|å°† 16 ä½æ•´æ•°ä»ç½‘ç»œå­—èŠ‚åºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚åº|
|`ntohl()`|å°† 32 ä½æ•´æ•°ä»ç½‘ç»œå­—èŠ‚åºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚åº|

**å¿…é¡»ä½¿ç”¨åœºæ™¯**ï¼š

- å‘Â `sin_port`Â èµ‹å€¼æ—¶ï¼ˆå¦‚Â `sad.sin_port = htons(8080);`ï¼‰
    
- ä»Â `sin_addr`Â è¯»å– IP åœ°å€æ—¶ï¼ˆé€šå¸¸è§£æå‡½æ•°å·²è¿”å›ç½‘ç»œå­—èŠ‚åºï¼Œä¸éœ€è½¬æ¢ï¼‰
    

---

## å…­ã€ä»£ç ç¤ºä¾‹è§£æ

### 1. TCP å®¢æˆ·ç«¯ç¤ºä¾‹ï¼ˆç®€åŒ–ï¼‰

```c

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netdb.h>
int main(int argc, char *argv[]) {
    int clientSocket;
    struct sockaddr_in serverAddr;
    struct hostent *server;
    char sentence[128], modifiedSentence[128];
    if (argc != 3) {
        fprintf(stderr, "ç”¨æ³•: %s <æœåŠ¡å™¨åŸŸå> <ç«¯å£å·>\n", argv[0]);
        exit(1);
    }
    // 1. åˆ›å»º socket
    clientSocket = socket(PF_INET, SOCK_STREAM, 0);
    if (clientSocket < 0) {
        perror("socket åˆ›å»ºå¤±è´¥");
        exit(1);
    }
    // 2. è§£ææœåŠ¡å™¨åŸŸå
    server = gethostbyname(argv[1]);
    if (server == NULL) {
        fprintf(stderr, "æ— æ³•è§£æåŸŸå\n");
        exit(1);
    }
    // 3. å¡«å……æœåŠ¡å™¨åœ°å€ç»“æ„
    memset(&serverAddr, 0, sizeof(serverAddr));
    serverAddr.sin_family = AF_INET;
    memcpy(&serverAddr.sin_addr, server->h_addr, server->h_length);
    serverAddr.sin_port = htons(atoi(argv[2]));
    // 4. è¿æ¥æœåŠ¡å™¨
    if (connect(clientSocket, (struct sockaddr *)&serverAddr, sizeof(serverAddr)) < 0) {
        perror("è¿æ¥å¤±è´¥");
        exit(1);
    }
    // 5. è·å–ç”¨æˆ·è¾“å…¥å¹¶å‘é€
    printf("è¯·è¾“å…¥å°å†™å¥å­: ");
    fgets(sentence, sizeof(sentence), stdin);
    send(clientSocket, sentence, strlen(sentence), 0);
    // 6. æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„å¤§å†™ç»“æœ
    recv(clientSocket, modifiedSentence, sizeof(modifiedSentence), 0);
    printf("ä»æœåŠ¡å™¨æ”¶åˆ°: %s\n", modifiedSentence);
    // 7. å…³é—­è¿æ¥
    close(clientSocket);
    return 0;
}
```
**å…³é”®ç‚¹**ï¼š

- ä½¿ç”¨Â `gethostbyname()`Â å°†åŸŸåè½¬ä¸º IPã€‚
    
- ç«¯å£å·ä»å‘½ä»¤è¡Œå‚æ•°è·å–ï¼Œå¹¶ç”¨Â `atoi()`Â è½¬ä¸ºæ•´æ•°ï¼Œå†ç”¨Â `htons()`Â è½¬æ¢ã€‚
    
- `connect()`Â åå³å®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œä¹‹åå¯ç›´æ¥æ”¶å‘æ•°æ®ã€‚
    

---

### 2. TCP æœåŠ¡å™¨ç¤ºä¾‹ï¼ˆç®€åŒ–ï¼‰


```c

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <ctype.h>
#include <sys/socket.h>
#include <netinet/in.h>
int main(int argc, char *argv[]) {
    int welcomeSocket, connectionSocket;
    struct sockaddr_in serverAddr, clientAddr;
    socklen_t clientLen;
    char clientSentence[128], capitalizedSentence[128];
    int i;
    if (argc != 2) {
        fprintf(stderr, "ç”¨æ³•: %s <ç«¯å£å·>\n", argv[0]);
        exit(1);
    }
    // 1. åˆ›å»º welcome socket
    welcomeSocket = socket(PF_INET, SOCK_STREAM, 0);
    if (welcomeSocket < 0) {
        perror("socket åˆ›å»ºå¤±è´¥");
        exit(1);
    }
    // 2. ç»‘å®šæœ¬åœ°åœ°å€
    memset(&serverAddr, 0, sizeof(serverAddr));
    serverAddr.sin_family = AF_INET;
    serverAddr.sin_addr.s_addr = htonl(INADDR_ANY);  // ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
    serverAddr.sin_port = htons(atoi(argv[1]));
    if (bind(welcomeSocket, (struct sockaddr *)&serverAddr, sizeof(serverAddr)) < 0) {
        perror("bind å¤±è´¥");
        exit(1);
    }
    // 3. ç›‘å¬
    if (listen(welcomeSocket, 10) < 0) {
        perror("listen å¤±è´¥");
        exit(1);
    }
    printf("æœåŠ¡å™¨æ­£åœ¨ç›‘å¬ç«¯å£ %s...\n", argv[1]);
    while (1) {
        // 4. æ¥å—è¿æ¥
        clientLen = sizeof(clientAddr);
        connectionSocket = accept(welcomeSocket, (struct sockaddr *)&clientAddr, &clientLen);
        if (connectionSocket < 0) {
            perror("accept å¤±è´¥");
            continue;
        }
        // 5. å¤„ç†è¯¥è¿æ¥ï¼ˆæ­¤å¤„å¯ fork å­è¿›ç¨‹ï¼‰
        memset(clientSentence, 0, sizeof(clientSentence));
        read(connectionSocket, clientSentence, sizeof(clientSentence) - 1);
        // è½¬æ¢ä¸ºå¤§å†™
        for (i = 0; clientSentence[i]; i++) {
            capitalizedSentence[i] = toupper(clientSentence[i]);
        }
        capitalizedSentence[i] = '\0';
        // å‘é€å›å®¢æˆ·ç«¯
        write(connectionSocket, capitalizedSentence, strlen(capitalizedSentence) + 1);
        // 6. å…³é—­è¿æ¥å¥—æ¥å­—
        close(connectionSocket);
    }
    // ç†è®ºä¸Šä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
    close(welcomeSocket);
    return 0;
}
```
**å…³é”®ç‚¹**ï¼š

- `INADDR_ANY`Â è¡¨ç¤ºç›‘å¬æ‰€æœ‰æœ¬åœ° IP åœ°å€ï¼ˆå¦‚æœæœ‰å¤šä¸ªç½‘å¡ï¼‰ã€‚
    
- `accept()`Â ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰è¿æ¥åˆ°è¾¾ï¼Œè¿”å›æ–°çš„è¿æ¥å¥—æ¥å­—ã€‚
    
- å¤„ç†å®Œä¸€ä¸ªå®¢æˆ·ç«¯åå…³é—­è¿æ¥å¥—æ¥å­—ï¼Œä½† welcome socket ä¿æŒæ‰“å¼€ï¼Œç»§ç»­æ¥å—æ–°è¿æ¥ã€‚
    

---

## ä¸ƒã€å¤šè¿›ç¨‹å¹¶å‘æœåŠ¡å™¨

å•çº¿ç¨‹ä¸²è¡Œå¤„ç†å®¢æˆ·ç«¯æ—¶ï¼Œå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚è€—æ—¶è¾ƒé•¿ï¼Œåç»­å®¢æˆ·ç«¯å¿…é¡»ç­‰å¾…ã€‚å¸¸è§æ”¹è¿›æ˜¯Â **æ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹**ã€‚

```c

while (1) {
    connectionSocket = accept(welcomeSocket, ...);
    if (fork() == 0) {          // å­è¿›ç¨‹
        close(welcomeSocket);    // å­è¿›ç¨‹å…³é—­æ¬¢è¿å¥—æ¥å­—
        // å¤„ç† connectionSocket ä¸Šçš„æ•°æ®äº¤æ¢...
        close(connectionSocket);
        exit(0);                 // å­è¿›ç¨‹ç»“æŸ
    }
    close(connectionSocket);     // çˆ¶è¿›ç¨‹å…³é—­è¿æ¥å¥—æ¥å­—
}
```
**è¦ç‚¹**ï¼š

- å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ‰€æœ‰æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤éœ€è¦å…³é—­è‡ªå·±ä¸éœ€è¦çš„å¥—æ¥å­—ï¼ˆå­è¿›ç¨‹å…³é—­ welcomeSocketï¼Œçˆ¶è¿›ç¨‹å…³é—­ connectionSocketï¼‰ã€‚
    
- å¤šä¸ªè¿›ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ªç›‘å¬ç«¯å£ï¼Œæ¯ä¸ªè¿æ¥ç”±ä¸åŒçš„ connection socket æ ‡è¯†ã€‚
    

---

## å…«ã€å¸¸è§é”™è¯¯ä¸æ³¨æ„äº‹é¡¹

|é”™è¯¯|åæœ|è§£å†³æ–¹æ³•|
|---|---|---|
|æœªè¿›è¡Œå­—èŠ‚åºè½¬æ¢|è¿æ¥å¤±è´¥ï¼ˆç«¯å£/IP é”™è¯¯ï¼‰|ä½¿ç”¨Â `htons()`ã€`htonl()`Â è½¬æ¢|
|æœªæ¸…é›¶Â `sockaddr_in`|åŒ…å«éšæœºå¡«å……å€¼ï¼Œå¯èƒ½ç»‘å®šå¤±è´¥|ä½¿ç”¨Â `memset(&addr, 0, sizeof(addr))`|
|`gethostbyname()`Â è¿”å› NULL|åŸŸåè§£æå¤±è´¥|æ£€æŸ¥åŸŸåæ˜¯å¦æ­£ç¡®ï¼Œç½‘ç»œæ˜¯å¦è¿é€š|
|`listen()`Â é˜Ÿåˆ—è¿‡çŸ­|é«˜å¹¶å‘æ—¶æ–°è¿æ¥è¢«æ‹’ç»|é€‚å½“å¢å¤§ backlogï¼ˆå¦‚ 128ï¼‰|
|å¤šè¿›ç¨‹æœåŠ¡ä¸­æœªå…³é—­å¤šä½™å¥—æ¥å­—|æ–‡ä»¶æè¿°ç¬¦æ³„æ¼|ä¸¥æ ¼ç®¡ç†å­è¿›ç¨‹/çˆ¶è¿›ç¨‹çš„å¥—æ¥å­—å…³é—­|

---

## ä¹ã€çŸ¥è¯†å°ç»“

|çŸ¥è¯†ç‚¹|æ ¸å¿ƒå†…å®¹|è€ƒè¯•é‡ç‚¹/æ˜“æ··æ·†ç‚¹|éš¾åº¦|
|---|---|---|---|
|**Socket æœ¬è´¨**|æ•´æ•°æè¿°ç¬¦ï¼Œä»£è¡¨è¿›ç¨‹ä¸åè®®æ ˆçš„æ¥å£|ç±»ä¼¼æ–‡ä»¶å¥æŸ„ï¼Œ`read()`/`write()`Â æ“ä½œ|â˜…â˜…â˜…|
|**TCP å¥—æ¥å­—ç±»å‹**|**æ¬¢è¿å¥—æ¥å­—**ï¼ˆç›‘å¬ï¼‰ä¸Â **è¿æ¥å¥—æ¥å­—**ï¼ˆæ•°æ®ï¼‰|`accept()`Â è¿”å›æ–°å¥—æ¥å­—ï¼ŒåŸå¥—æ¥å­—ç»§ç»­ç›‘å¬|â˜…â˜…â˜…â˜…|
|**æœåŠ¡å™¨æµç¨‹**|`socket()`Â â†’Â `bind()`Â â†’Â `listen()`Â â†’Â `accept()`Â â†’Â `read()/write()`Â â†’Â `close()`|`bind()`Â å›ºå®šçŸ¥åç«¯å£ï¼Œ`listen()`Â è®¾ç½®é˜Ÿåˆ—|â˜…â˜…â˜…â˜…|
|**å®¢æˆ·ç«¯æµç¨‹**|`socket()`Â â†’Â `connect()`Â â†’Â `read()/write()`Â â†’Â `close()`|æ— éœ€Â `bind()`ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸´æ—¶ç«¯å£|â˜…â˜…â˜…â˜…|
|**æ•°æ®ç»“æ„**|`sockaddr_in`ï¼ˆIP+ç«¯å£ï¼‰ã€`hostent`ï¼ˆåŸŸåè§£æç»“æœï¼‰|`sin_port`/`sin_addr`Â éœ€ç½‘ç»œå­—èŠ‚åºï¼›`gethostbyname()`Â è¿”å›çš„ IP ç›´æ¥ä½¿ç”¨|â˜…â˜…â˜…|
|**å­—èŠ‚åºè½¬æ¢**|å¤§ç«¯ç½‘ç»œå­—èŠ‚åº vs ä¸»æœºå­—èŠ‚åº|`htons()`ã€`htonl()`ã€`ntohs()`ã€`ntohl()`|â˜…â˜…â˜…|
|**å¤šè¿›ç¨‹æ¨¡å‹**|ä¸»è¿›ç¨‹ç›‘å¬ï¼Œå­è¿›ç¨‹å¤„ç†è¿æ¥|å­è¿›ç¨‹éœ€å…³é—­ welcome socketï¼Œçˆ¶è¿›ç¨‹éœ€å…³é—­ connection socket|â˜…â˜…â˜…â˜…|
|**æµå¼è¾¹ç•Œ**|TCP ä¸ç»´æŠ¤æŠ¥æ–‡è¾¹ç•Œï¼Œå¯èƒ½ç²˜åŒ…|åº”ç”¨å±‚éœ€è‡ªå·±å®šä¹‰æ¶ˆæ¯è¾¹ç•Œï¼ˆå¦‚é•¿åº¦å­—æ®µã€å®šç•Œç¬¦ï¼‰|â˜…â˜…â˜…â˜…â˜…|

---

## åã€æ€»ç»“

TCP å¥—æ¥å­—ç¼–ç¨‹æ˜¯ç½‘ç»œåº”ç”¨å¼€å‘çš„æ ¸å¿ƒæŠ€èƒ½ã€‚é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ åº”å½“ï¼š

- ç†è§£Â **æ¬¢è¿å¥—æ¥å­—**Â ä¸Â **è¿æ¥å¥—æ¥å­—**Â çš„èŒè´£åˆ†ç¦»ã€‚
    
- æŒæ¡Â `socket()`ã€`bind()`ã€`listen()`ã€`accept()`ã€`connect()`ã€`close()`Â çš„å®Œæ•´æµç¨‹ã€‚
    
- ç†Ÿæ‚‰Â `sockaddr_in`Â å’ŒÂ `hostent`Â ç»“æ„ä½“çš„ä½¿ç”¨ã€‚
    
- ç‰¢è®°Â **ç½‘ç»œå­—èŠ‚åºè½¬æ¢**Â çš„å¿…è¦æ€§ã€‚
    
- èƒ½å¤Ÿç¼–å†™ç®€å•çš„Â **å¹¶å‘æœåŠ¡å™¨**ï¼ˆå¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ï¼‰ã€‚
    

è¿™äº›çŸ¥è¯†å°†ä¸ºä½ åç»­å­¦ä¹  HTTP æœåŠ¡å™¨ã€ä»£ç†æœåŠ¡å™¨ã€è‡ªå®šä¹‰åº”ç”¨å±‚åè®®ç­‰å¥ å®šåšå®åŸºç¡€ã€‚