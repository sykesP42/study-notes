# 📘 Lecture 2：函数、环境与抽象 

> 本笔记从名称绑定开始，逐步深入函数的定义与调用、环境与作用域、赋值规则、纯函数与非纯函数的区别等。每一部分都配有详细的原理说明、代码示例、环境图分析和自测题，帮助你建立对Python执行模型的深刻理解。

---

## 一、名称、赋值与用户自定义函数

### 1. 名称的导入与绑定

Python中的**名称**（name）是对**值**的引用。大多数内置名称（如数学常数、函数）需要通过 `import` 语句导入后才能使用。

#### 示例：导入 `pi` 和 `sin`

```python

from math import pi, sin
```

- 导入后，`pi` 被绑定到近似值 `3.141592653589793`
    
- `sin` 被绑定到正弦函数对象
    

#### 名称绑定特性

- 一个名称可以绑定到任何类型的值（数字、函数、字符串等）
    
- 名称可以重新绑定到另一个值
    
- 导入的名称可以与表达式自由组合：
    

```python

>>> pi * 71 / 223   # 近似计算 π 的近似值
1.000238

```
### 2. 赋值语句

赋值语句是 Python 中最基本的绑定方式，语法为：

```python

name = expression
```
- 先计算等号右侧的表达式，得到值
    
- 然后将左侧的名称绑定到该值
    

#### 多重赋值

可以同时给多个名称赋值：

```python

radius = 10
area, circumference = pi * radius * radius, 2 * pi * radius
```
- 右侧表达式按顺序求值，得到两个值
    
- 左侧名称按顺序绑定到对应的值
    

> ⚠️ **注意**：名称只记住最终绑定的值，不记忆计算过程。修改 `radius` 后，`area` 不会自动更新。

#### 动态计算：使用函数实现

若希望 `area` 随 `radius` 变化，可以定义函数：

```python

def area():
    return pi * radius * radius
```
每次调用 `area()` 都会重新计算当前 `radius` 的值。

### 3. 函数别名与名称覆盖

#### 函数别名

可以将内置函数赋给其他名称：

```python

f = max          # 现在 f 和 max 都指向同一个函数对象
```
#### 名称覆盖

可以重新绑定内置函数名：

```python

max = 7          # 现在 max 变成了数字 7，不再是函数
```
#### 恢复方法

如果之前保存了别名，可以通过别名恢复：

```python

max = f          # 将 max 重新绑定回原来的函数
```
### 4. 表达式的类型

#### 原始表达式

- **数字常量**：`2`，`3.14`
    
- **名称引用**：`pi`，`max`（前提是已绑定）
    
- **字符串**：`'hello'`，`"world"`
    

#### 调用表达式

- 基本结构：`operator(operand1, operand2, ...)`
    
- 允许无参数调用：`area()`
    
- 支持嵌套：`f(g(h(1,5), 3))`
    

### 5. 应用案例：名称追踪题

#### 题目

```python

>>> f = min
>>> f = max
>>> g, h = min, max
>>> max = g
>>> max(f(2, g(h(1,5), 3)), 4)
```
问：最终表达式的值是多少？

#### 逐步解析

我们需要追踪每个名称的当前绑定：

|代码|执行后绑定|
|---|---|
|`f = min`|f → min 函数|
|`f = max`|f → max 函数|
|`g, h = min, max`|g → min 函数，h → max 函数|
|`max = g`|max → min 函数|

现在：

- `f` → max 函数
    
- `g` → min 函数
    
- `h` → max 函数
    
- `max` → min 函数
    

计算内层表达式：

1. `h(1,5)` → max(1,5) = 5
    
2. `g(5,3)` → min(5,3) = 3
    
3. `f(2,3)` → max(2,3) = 3
    
4. `max(3,4)` → min(3,4) = 3
    

最终结果为 **3**。

> 💡 关键：名称绑定是动态的，同一名称在不同时刻可能指向不同值。

---

## 二、定义函数

### 1. 抽象的力量

- **赋值**：简单的抽象，将名称绑定到值
    
- **函数定义**：更强大的抽象，将名称绑定到表达式（计算过程）
    

抽象让我们能够将复杂操作封装为一个名称，使用时只需关注其功能，而无需关心内部细节。

### 2. 函数定义的语法

```python

def <函数名>(<形式参数>):
    return <返回表达式>
```
- `def` 关键字
    
- 函数名（标识符）
    
- 括号内是形式参数列表（可以没有参数）
    
- 冒号结束签名
    
- 缩进的函数体，通常包含 `return` 语句
    

#### 示例：定义平方函数

```python

from operator import mul
def square(x):
    return mul(x, x)
```
### 3. 函数签名与参数

函数签名由函数名和形式参数列表组成，它定义了函数需要的参数个数和名称。

- 在调用时，每个形式参数会被绑定到对应的实际参数值
    
- 签名信息被存储在函数对象中，用于每次调用时创建局部帧
    

### 4. 函数体与功能定义

函数体是缩进的代码块，定义了函数的具体行为。最简单的函数体只包含一个 `return` 语句。

- `return` 后跟的表达式在每次调用时求值，结果作为函数返回值
    
- 函数体可以包含多条语句，但至少有一个 `return`（如果没有，函数返回 `None`）
    

### 5. 函数定义执行过程

当 Python 执行 `def` 语句时，它会：

1. 创建一个新的函数对象
    
2. 将函数对象绑定到指定的名称（在当前帧中）
    

> 函数定义本身**不会执行函数体**，只记录函数体和参数信息。

---

## 三、调用用户自定义函数的步骤

调用函数时，Python 执行以下三步：

1. **创建一个新的局部帧**，形成一个新的环境（局部帧 + 全局帧）
    
2. **将形式参数绑定到实际参数**：在新帧中，形参名被绑定到传入的实参值
    
3. **在新环境中执行函数体**：函数体内的名称查找会先访问局部帧，再到全局帧
    

#### 示例：调用 `square(-2)`

```python

from operator import mul
def square(x):
    return mul(x, x)
square(-2)
```
执行过程：

- 全局帧已有 `mul` 和 `square` 的绑定
    
- 调用 `square(-2)`：
    
    - 创建新帧（标记为 `square`）
        
    - 将 `x` 绑定到 `-2`
        
    - 在新帧中执行 `return mul(x, x)`
        
    - 查找 `mul`：在局部帧找不到，到全局帧找到 `mul` 函数
        
    - 计算 `mul(-2, -2)` 得到 `4`
        
    - 返回 `4`，局部帧被销毁
        

> 💡 局部帧在函数返回后通常会被丢弃（除非有闭包等特殊情况）。

---

## 四、查找名称和环境

### 1. 环境的概念

**环境**（environment）是名称到值的映射的序列。每个帧（frame）是一个映射表。

- 当前环境由一系列帧组成，按顺序从最内层（当前函数局部帧）到最外层（全局帧）
    
- 表达式总是在某个环境中求值
    

### 2. 名称查找规则

> **名称求值**：返回当前环境中**最早**包含该名称的帧中绑定的值。

即：从局部帧开始查找，若找不到则到全局帧，再找不到则报错 `NameError`。

### 3. 示例：局部变量覆盖全局变量

```python

def square(square):     # 形式参数也叫 square
    return mul(square, square)
square(4)
```
调用时：

- 局部帧中 `square` 绑定到 `4`
    
- 在函数体内，`mul` 在全局帧找到，`square` 在局部帧找到（值为4）
    
- 正确计算 `4*4`，不会混淆全局函数 `square`
    

> ⭐ **作用域隔离**：函数参数和局部变量不会污染全局命名空间。

---

## 五、环境图 —— 可视化执行过程

### 1. 什么是环境图？

环境图是 Python 解释器执行程序时，记录名称绑定状态的可视化工具。它帮助我们理解作用域、帧、名称查找等抽象概念。

### 2. 环境图的构成

- **代码区**：左侧显示 Python 代码，灰色箭头标记已执行行，红色箭头标记下一行
    
- **帧区**：右侧显示帧和名称绑定。每个帧是一个方框，内部列出名称 → 值的映射
    

#### 示例

```python

from math import pi
tau = 2 * pi
```
执行后环境图：

- 全局帧：`pi` → 3.14159...，`tau` → 6.28318...
    

### 3. 在线工具：Python Tutor

推荐使用 [Python Tutor](https://pythontutor.com/) 在线可视化工具。输入代码，点击“Visualize Execution”，即可逐步观察环境变化。

> ✅ 非常适合初学者理解函数调用、赋值、作用域等。

---

## 六、赋值语句的执行规则

### 1. 赋值语句的执行步骤

```python

<左侧名称> = <右侧表达式>
```
执行规则：

1. **从左到右**计算等号右侧的所有表达式
    
2. 将左侧的名称绑定到右侧对应值（按顺序）
    

#### 多重赋值的细节

```python

a, b = a + b, b
```
- 先计算右侧 `a + b` 和 `b` 的值（使用当前 `a`、`b` 的值）
    
- 再将第一个值赋给 `a`，第二个值赋给 `b`
    

#### 示例

```python

a = 1
b = 2
a, b = a + b, a   # 右侧：a+b=3, a=1 → (3,1)

# 此时 a 被赋值为 3，b 被赋值为 1
```
### 2. 名称绑定的覆盖

在同一帧中，一个名称只能绑定到一个值。重新赋值会覆盖旧绑定。

```python

max = 7      # max 现在绑定到 7
max(1,2)     # 报错，因为 7 不是函数
```
---

## 七、表达式求值与 `print` 函数

### 1. 交互式解释器的自动显示

在交互式环境中，输入表达式会自动显示其求值结果：

```python

>>> -2
-2
>>> 'Go Bears!'
'Go Bears!'
```
### 2. `print` 函数的特点

- `print` 是一个**非纯函数**，它会将内容输出到控制台（副作用），并返回 `None`
    
- 输出时会去掉字符串的引号，多个参数用空格分隔
    

```python

>>> print(1, 2)
1 2
```
### 3. 嵌套 `print` 的执行顺序

```python

print(print(1), print(2))
```
执行过程：

1. 计算最内层 `print(1)`：输出 `1`，返回 `None`
    
2. 计算 `print(2)`：输出 `2`，返回 `None`
    
3. 外层 `print(None, None)`：输出 `None None`，返回 `None`
    

最终输出：

```text

1
2
None None
```
> ⚠️ `None` 在交互式解释器中不会自动显示，但被 `print` 打印时会显示为 `None`。

---

## 八、`None` —— 表示“无”的特殊值

- `None` 是 Python 中唯一的 `NoneType` 类型的值
    
- 没有 `return` 语句的函数默认返回 `None`
    
- 交互式解释器不会显示 `None` 作为表达式结果
    
- 对 `None` 进行运算会导致类型错误
    

#### 示例

```python

def no_return(x):
    x * x
result = no_return(4)
print(result)   # 输出 None
result + 4      # TypeError: unsupported operand type(s) for +: 'NoneType' and 'int'
```
---

## 九、纯函数与非纯函数

### 1. 纯函数

- **定义**：仅根据输入参数返回值，没有其他影响（无副作用）
    
- **特征**：相同输入总是返回相同输出，不改变外部状态
    
- **示例**：`abs`、`add`、`mul`
    

```python

>>> abs(-2)
2
```
### 2. 非纯函数

- **定义**：除了返回值，还会产生副作用（如修改全局变量、输入输出、改变可变对象等）
    
- **特征**：相同输入可能产生不同效果，或改变外部状态
    
- **示例**：`print`（输出到控制台）、`list.append`（修改列表）
    

```python

>>> print(42)
42
>>> lst = [1,2]
>>> lst.append(3)   # 修改 lst
```
### 3. 对比

|特性|纯函数|非纯函数|
|---|---|---|
|返回值|总是有|可能有（如 `print` 返回 `None`）|
|副作用|无|有|
|可预测性|高|低（依赖外部状态）|
|示例|`abs`, `math.sqrt`|`print`, `list.sort`|

---

## 十、知识点总结表（含扩展说明）

|知识点|核心内容|详细说明 / 示例|常见错误 / 易混淆点|难度|
|---|---|---|---|---|
|**名称绑定**|名称指向值，可重复赋值|`pi = 3.14` 后 `pi` 就是 3.14|重新绑定内置名称后原函数丢失|⭐⭐|
|**赋值语句**|先计算右侧，再绑定左侧|`a, b = b, a` 交换变量|右侧顺序从左到右，左侧同步绑定|⭐⭐⭐|
|**函数定义**|`def` 创建函数对象，不执行体|`def square(x): return x*x`|忘记冒号或缩进|⭐⭐|
|**函数调用过程**|创建局部帧，绑定参数，执行体|调用 `square(3)` 创建新帧绑定 `x=3`|混淆形参与实参|⭐⭐⭐|
|**环境与名称查找**|从局部帧到全局帧顺序查找|函数内变量优先用局部|局部变量覆盖全局同名变量|⭐⭐⭐|
|**环境图**|可视化帧和绑定|Python Tutor 工具|不理解帧的创建与销毁|⭐⭐|
|**`None`**|表示无返回值的特殊对象|无 `return` 的函数返回 `None`|对 `None` 进行运算会报错|⭐⭐|
|**纯函数**|无副作用，仅返回结果|`abs(-2)` 总是返回 2|认为 `print` 是纯函数|⭐⭐|
|**非纯函数**|有副作用|`print(1)` 输出并返回 `None`|混淆返回值与副作用|⭐⭐⭐|
|**嵌套 `print`**|内层先执行，返回值作为外层参数|`print(print(1), print(2))`|输出顺序与返回值混淆|⭐⭐⭐|

---

## 十一、自测题 —— 检验理解

### 1. 名称追踪

```python

x = 5
y = x
x = 10
print(y)   # 输出什么？
```
<details> <summary>答案</summary> 5。`y` 绑定的是 `x` 当时的值（5），不是引用关系。 </details>

### 2. 函数调用与环境

```python

def f(x):
    return g(x) + 1
def g(x):
    return x * 2
print(f(3))
```
画出调用 `f(3)` 时的环境图（帧和绑定）。

<details> <summary>过程</summary> 1. 全局帧：f→函数，g→函数<br> 2. 调用 f(3)：创建 f 局部帧，x=3<br> 3. 执行 f 体：计算 g(x)，查找 g 在全局帧找到，调用 g(3)<br> 4. 调用 g(3)：创建 g 局部帧，x=3<br> 5. g 返回 6，回到 f 帧，计算 6+1=7，返回 7<br> 6. 输出 7 </details>

### 3. 纯函数与非纯函数

判断以下函数是否为纯函数：

- `math.sqrt`
    
- `print`
    
- `list.append`
    
- `max`
    

<details> <summary>答案</summary> 纯函数：`math.sqrt`、`max`<br> 非纯函数：`print`（副作用输出）、`list.append`（修改列表） </details>

### 4. 思考题

如果 Python 没有 `None`，如何表示一个函数没有返回值？这样做会有什么问题？

<details> <summary>提示</summary> 可能需要约定一个特殊值（如 `-1`）表示无返回值，但可能和有效返回值冲突。`None` 作为一个独立的空值类型，避免了歧义。 </details>

---

## 十二、总结与展望

本节课深入讲解了函数、环境、赋值和副作用等核心概念，这些是理解 Python 程序执行的基础。后续课程将在此基础上引入复合数据、递归、高阶函数等更抽象的内容。建议你：

- 多使用 Python Tutor 观察环境变化
    
- 动手练习名称追踪题
    
- 区分纯函数与非纯函数，理解副作用的含义