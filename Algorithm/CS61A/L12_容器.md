# 📘 Lecture 12：容器 —— 列表、字符串与字典

> 本笔记深入探讨 Python 中的容器类型：列表（list）、字符串（str）和字典（dict）。你将学习如何用方框与指针表示法可视化列表结构，理解闭包属性如何支持嵌套，掌握切片操作，了解序列聚合函数，并学会使用字典这种键值对映射结构及其推导式。

---

## 一、方框与指针表示法

### 1. 什么是方框与指针表示法？

**方框与指针表示法**（Box-and-Pointer Notation）是环境图中用于表示列表等复合数据的一种可视化方法。它将列表画成一排带索引标签的方框，每个方框代表一个元素；如果元素是原始值（如整数、字符串），则直接在方框内写出；如果元素是复合值（如另一个列表），则方框中画一个箭头指向另一个列表的结构。

这种表示法能清晰地展现数据结构的层次和共享关系。

### 2. 闭包属性

> **闭包属性**（Closure Property）是指：组合数据值的方法得到的结果，可以再次用同样的方法进行组合。

对于列表而言，这意味着列表的元素可以是列表，从而形成任意深度的嵌套结构。这正是我们能用方框和指针表示多层嵌套列表的原因。

**示例**：


```python

nested = [[1, 2], [], [1, [3, False, None]]]
```
用方框与指针表示时：

- `nested[0]` 指向一个包含 `1` 和 `2` 的两个方框的列表。
    
- `nested[1]` 指向一个空列表（没有方框）。
    
- `nested[2]` 指向一个包含三个元素的列表：第一个元素是 `1`，第二个元素指向另一个列表（包含 `3, False, None`），第三个元素是 `None`。
    

> 💡 闭包属性是构建复杂数据结构的基础，它使得我们可以用简单的部件构造出层次丰富的结构。

### 3. 环境图中的列表表示

在环境图中，列表变量名绑定到列表对象。列表对象用一系列带索引的方框表示，每个方框要么直接包含原始值，要么通过箭头指向另一个列表对象。

**简单示例**：

```python

pair = [1, 2]
```
环境图中：

- 变量 `pair` 指向一个包含两个方框的列表对象，方框内分别是 `1` 和 `2`。
    

**嵌套示例**：

```python

nested = [[1, 2], [3, 4]]
```
环境图中：

- `nested` 指向一个包含两个方框的列表对象。
    
- 第一个方框的箭头指向另一个列表对象，该列表的两个方框内是 `1` 和 `2`。
    
- 第二个方框的箭头指向另一个列表对象，该列表的两个方框内是 `3` 和 `4`。
    

---

## 二、切片操作

### 1. 基本语法

切片（slice）用于从序列（如列表、字符串、range）中提取子序列。基本语法为：

```python

sequence[start:end]
```
- `start`：起始索引（包含），可省略，默认为 `0`。
    
- `end`：结束索引（不包含），可省略，默认为序列长度。
    
- 返回一个新序列（原序列不变）。
    

**示例**：

```python

odds = [3, 5, 7, 9, 11]
odds[1:3]   # [5, 7]
odds[:3]    # [3, 5, 7]
odds[1:]    # [5, 7, 9, 11]
odds[:]     # [3, 5, 7, 9, 11]（整个列表的副本）
```
### 2. 切片创建新值

切片总是返回一个新列表（或其他序列类型），原序列不受影响。这意味着可以通过切片来复制列表（`list_copy = lst[:]`）。

### 3. 步长切片

切片还可以指定步长：

```python

sequence[start:end:step]
```
例如：

```python

odds[::2]   # [3, 7, 11]（每隔一个取一个）
odds[::-1]  # [11, 9, 7, 5, 3]（反转）
```
---

## 三、序列聚合函数

Python 内置了一些函数，可以将可迭代对象（如列表、range）聚合成单个值。

### 1. `sum(iterable, start=0)`

- 返回 `iterable` 中所有数字的和加上 `start`（默认为 0）。
    
- 要求 `iterable` 的元素必须是数字（不能是字符串）。
    
- 若 `iterable` 为空，返回 `start`。
    

**高级用法**：可用于连接列表（但效率不高，不推荐）：

```python

sum([[2,3], [4]], [])   # [2, 3, 4]
```
这是因为 `[]` 作为 `start`，然后逐次与子列表相加（`+` 操作符连接列表）。但这样做会产生很多中间列表，通常建议使用列表推导或 `itertools.chain`。

### 2. `max(iterable, *[, key])` 或 `max(arg1, arg2, *args[, key])`

- 返回可迭代对象中的最大值，或返回多个参数中的最大值。
    
- `key` 参数指定一个单参数函数，用于从每个元素中提取比较键。
    

**示例**：

```python

max([3, 7, 2, 9])                     # 9
max(range(10), key=lambda x: (x-4)*(x-2))  # 3
```
第二个例子中，`key` 函数计算 `(x-4)*(x-2)`，这个值在 `x=3` 时最大（因为抛物线开口向上，顶点在 x=3 附近）。

### 3. `all(iterable)`

- 如果 `iterable` 中所有元素的布尔值都为 `True`，则返回 `True`；否则返回 `False`。
    
- 空可迭代对象返回 `True`（空真）。
    

**真值规则**：

- 数字：`0` 为 `False`，非零为 `True`。
    
- 字符串：空字符串 `''` 为 `False`，非空为 `True`。
    
- 其他容器：空列表、空字典等为 `False`，非空为 `True`。
    

**示例**：

```python

all([x < 5 for x in range(5)])   # True（所有 0~4 都小于 5）
all([0, 1, 2, 3])                 # False（0 为假）
```
---

## 四、字符串

### 1. 字符串是文本的抽象

字符串（`str`）用于表示文本数据。我们不需要关心底层的编码细节（如 Unicode），只需将其视为字符序列。

字符串可以包含数字、科学计数法、布尔值文字等，例如：`"200"`、`"1.2e-5"`、`"False"`、`"(1,2)"`。它们只是字符序列，不一定代表有意义的数据。

### 2. 字符串字面量的三种形式

|形式|示例|说明|
|---|---|---|
|单引号|`'I am string!'`|最常用，但内部不能包含未转义的单引号。|
|双引号|`"I've got an apostrophe"`|内部可以包含单引号（撇号）。|
|三引号|`"""多行字符串"""` 或 `'''多行'''`|可跨越多行，常用于文档字符串。|

此外，可以使用转义字符，如 `'\n'` 表示换行，`'\t'` 表示制表符。

### 3. 字符串是序列

字符串支持序列的通用操作：

- 索引：`s[0]` 获取第一个字符。
    
- 切片：`s[1:3]` 获取子串。
    
- 长度：`len(s)`
    
- 成员检测：`'a' in s`
    
- 迭代：`for ch in s:`
    

但字符串是不可变的（immutable），不能修改其中的字符。

---

## 五、字典

### 1. 字典的创建

字典（`dict`）是键值对（key-value pair）的集合，用花括号 `{}` 表示，键和值之间用冒号 `:` 分隔，键值对之间用逗号分隔。

```python

numerals = {'I': 1, 'V': 5, 'X': 10}
```
- 键通常是不可变类型（如字符串、数字、元组），值可以是任意类型（包括列表、字典等）。
    
- 空字典：`d = {}` 或 `d = dict()`。
    

### 2. 根据键查找值

通过方括号 `[]` 传入键来获取对应的值：

```python

numerals['V']   # 5
```
如果键不存在，会引发 `KeyError`。

**常用方法**：

- `list(numerals)` 返回所有键的列表（迭代时也是键）。
    
- `numerals.values()` 返回所有值的视图（可用 `list()` 转换为列表）。
    
- `numerals.items()` 返回键值对元组的视图。
    

### 3. 字典的键的限制

- 键必须是**可哈希**（hashable）的类型，即不可变类型。列表、字典等可变类型不能作为键，否则会引发 `TypeError: unhashable type`。
    
- 同一字典中键不能重复，如果重复赋值，后定义的会覆盖前一个。
    

### 4. 字典推导式

字典推导式（dictionary comprehension）用于从可迭代对象构建字典，语法类似列表推导式，但使用花括号和冒号。

**基本形式**：

```python

{<key_expr>: <value_expr> for <name> in <iterable> if <condition>}
```
**执行过程**：

1. 创建一个新的空字典。
    
2. 按顺序遍历 `<iterable>` 中的每个元素，将其赋值给 `<name>`。
    
3. 如果 `<condition>` 存在且为假，跳过该元素；否则计算 `<key_expr>` 和 `<value_expr>`，将键值对加入字典。
    
4. 返回新字典。
    

**示例**：将数字 0~9 映射为其平方。

```python

{x: x*x for x in range(10)}
```
### 5. 应用案例：`index` 函数

题目要求实现一个函数 `index(keys, values, match)`，返回一个字典，其中每个键 `k` 对应一个列表，包含所有使得 `match(k, v)` 为真的值 `v`。

**实现**：

```python

def index(keys, values, match):
    return {k: [v for v in values if match(k, v)] for k in keys}
```
**示例**：

```python

>>> index([7, 9, 11], range(30, 50), lambda k, v: v % k == 0)
{7: [35, 42, 49], 9: [36, 45], 11: [33, 44]}
```
解释：

- 外层字典推导遍历每个键 `k`。
    
- 内层列表推导遍历所有值 `v`，筛选出能被 `k` 整除的，构建值列表。
    

---

## 六、知识点总结表

|知识点|核心内容|考试重点 / 易混淆点|难度|
|---|---|---|---|
|**方框与指针**|可视化列表结构的方法，每个元素一个方框，箭头指向复合值|嵌套列表的指针追踪|⭐⭐|
|**闭包属性**|组合结果可再次组合，实现无限嵌套|列表包含列表的理论基础|⭐⭐|
|**切片**|`list[start:end:step]`，左闭右开，省略时默认开头或结尾|边界是否包含；切片返回新列表|⭐⭐|
|**聚合函数**|`sum`（数字求和）、`max`（最大值，可带 key）、`all`（全真）|`sum` 不能用于字符串；`max` 的 key 函数；`all([])` 为 True|⭐⭐|
|**字符串字面量**|单引号、双引号、三引号，转义字符|不同引号的适用场景|⭐|
|**字符串序列**|索引、切片、迭代、成员检测，但不可变|与列表的异同|⭐|
|**字典基础**|键值对集合，键不可变，值任意|键的唯一性和哈希要求|⭐⭐|
|**字典操作**|通过键查找、`.keys()`、`.values()`、`.items()`|视图 vs 列表|⭐⭐|
|**字典推导式**|`{k_expr: v_expr for item in iter if cond}`|键值表达式顺序|⭐⭐⭐|
|**`index` 函数**|字典推导式与列表推导式嵌套|双重推导的逻辑|⭐⭐⭐|

---

## 七、自测题

### 1. 方框与指针

画出以下代码执行后的环境图（方框与指针表示）：

```python

a = [1, 2]
b = [a, a]
c = [b, 3]
```

```
- 变量 `a` 指向一个有两个方框的列表，方框内分别是 `1` 和 `2`。
    
- 变量 `b` 指向一个有两个方框的列表，两个方框的箭头都指向 `a` 指向的同一个列表。
    
- 变量 `c` 指向一个有两个方框的列表，第一个方框的箭头指向 `b` 指向的列表，第二个方框内是 `3`。
    

（可以用箭头表示共享结构。）

```

### 2. 切片预测

给定 `lst = [2, 4, 6, 8, 10]`，写出下列切片的结果：

- `lst[1:4]`
    
- `lst[:3]`
    
- `lst[2:]`
    
- `lst[-2:]`
    
- `lst[::-1]`
    

```
- `lst[1:4]` → `[4, 6, 8]`
    
- `lst[:3]` → `[2, 4, 6]`
    
- `lst[2:]` → `[6, 8, 10]`
    
- `lst[-2:]` → `[8, 10]`
    
- `lst[::-1]` → `[10, 8, 6, 4, 2]`
    
```

### 3. 聚合函数

判断下列表达式的值：

- `sum([1, 2, 3])`
    
- `sum([1, 2, 3], 10)`
    
- `max([-5, 0, 10], key=abs)`
    
- `all([x > 0 for x in [1, 2, -3]])`
    
- `all([])`
    

```
- `sum([1,2,3])` → `6`
    
- `sum([1,2,3], 10)` → `16`
    
- `max([-5,0,10], key=abs)` → `-5`（因为绝对值最大是 10？等等，abs(-5)=5, abs(0)=0, abs(10)=10，最大值是 10，所以应该返回 10？注意 max 返回的是原始值，不是 key 的值。key=abs 表示比较绝对值，绝对值最大的是 10，所以返回 10。正确。）
    
- `all([x > 0 for x in [1,2,-3]])` → `[True, True, False]` 中有一个 False，所以 `all` 返回 `False`。
    
- `all([])` → `True`（空真）
    
```

### 4. 字符串操作

写出以下表达式的值：

- `'hello'[1]`
    
- `'hello'[1:4]`
    
- `'a' in 'abc'`
    
- `'A' in 'abc'`
    
- `len('hello\nworld')`
    

```
- `'hello'[1]` → `'e'`
    
- `'hello'[1:4]` → `'ell'`
    
- `'a' in 'abc'` → `True`
    
- `'A' in 'abc'` → `False`（大小写敏感）
    
- `len('hello\nworld')` → `11`（`\n` 是一个字符）
    
```

### 5. 字典操作

给定 `d = {'a': 1, 'b': 2, 'c': 3}`，写出以下表达式的值：

- `d['b']`
    
- `list(d)`
    
- `d.values()`
    
- `list(d.items())`
    

```
- `d['b']` → `2`
    
- `list(d)` → `['a', 'b', 'c']`
    
- `d.values()` → 一个视图对象，类似 `dict_values([1,2,3])`
    
- `list(d.items())` → `[('a', 1), ('b', 2), ('c', 3)]`
    
```

### 6. 字典推导式

用字典推导式生成一个字典，将 0~9 的数字映射为它们的立方。

```python

{x: x**3 for x in range(10)}
```

### 7. 思考题

为什么字典的键必须是不可变类型？如果允许列表作为键，会有什么问题？

<details> <summary>提示</summary>

字典基于哈希表实现，键的哈希值用于快速定位。如果键是可变的（如列表），修改后哈希值会改变，导致字典无法正确找到该键。因此 Python 要求键必须是可哈希的不可变类型。

</details>

---

## 八、总结与展望

本节课我们学习了三种重要的容器类型：列表、字符串和字典。掌握了方框与指针表示法，理解了闭包属性对嵌套结构的支持，学会了切片和聚合函数，并深入了解了字典的键值映射及其推导式。这些知识是后续学习数据抽象、算法设计的基础。在下一讲中，我们将探讨可变数据及其带来的副作用。